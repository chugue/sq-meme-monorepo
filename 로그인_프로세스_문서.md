# ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ë¶„ì„ ë¬¸ì„œ

## ê°œìš”

ì´ ë¬¸ì„œëŠ” Squid Meme Extensionì˜ ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë‹¨ê³„ë³„ë¡œ ë¶„ì„í•œ ìƒì„¸ ë¬¸ì„œì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê° ë™ì‘ê³¼ ê·¸ì— ë”°ë¥¸ ì½”ë“œ ì‹¤í–‰, ë°ì´í„° íë¦„ì„ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ê³¼ í•¨ê»˜ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## 1. ì•± ì´ˆê¸°í™” ë‹¨ê³„

### 1.1 ì•± ì‹œì‘ (App.tsx)

**ìœ„ì¹˜**: `frontend/src/sidepanel/App.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰)

**ì½”ë“œ ë™ì‘**:

```12:20:frontend/src/sidepanel/App.tsx
export function SidePanelApp() {
    const { isConnected, address, isLoading } = useSidepanelWallet();
    const { isLoggedIn: isMemexLoggedIn, setLoggedIn: setMemexLoggedIn } = useMemexLogin();
    const [currentPage, setCurrentPage] = useState<Page>("dashboard");
    const [showStartingLoading, setShowStartingLoading] = useState(true);
```

**ë°ì´í„° íë¦„**:
- `useSidepanelWallet()` í›… í˜¸ì¶œ â†’ ì§€ê°‘ ì—°ê²° ìƒíƒœ í™•ì¸ ì‹œì‘
- `useMemexLogin()` í›… í˜¸ì¶œ â†’ MEMEX ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹œì‘
- `showStartingLoading` ìƒíƒœê°€ `true`ë¡œ ì´ˆê¸°í™”

**ì €ì¥ ìœ„ì¹˜**: 
- `sessionAtom` (Jotai atom) - `sessionStorage`ì— ìë™ ë™ê¸°í™”
- í‚¤: `squid_session_state`

---

### 1.2 StartingLoading í‘œì‹œ

**ìœ„ì¹˜**: `frontend/src/sidepanel/StartingLoading.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ í‘œì‹œ)

**ì½”ë“œ ë™ì‘**:

```49:88:frontend/src/sidepanel/StartingLoading.tsx
export default function StartingLoading({ onComplete, duration = 3000 }: StartingLoadingProps) {
    const [hasPlayed, setHasPlayed] = useState(false);
    const imgRef = useRef<HTMLImageElement>(null);
    const timeoutRef = useRef<NodeJS.Timeout | null>(null);

    // ìƒë‹¨ê³¼ í•˜ë‹¨ ë³„ë“¤ ìƒì„± (í•œ ë²ˆë§Œ ìƒì„±)
    const [topStars] = useState(() => generateStars(30, { min: 0, max: 20 })); // ìƒë‹¨ 0-20%
    const [bottomStars] = useState(() => generateStars(30, { min: 80, max: 100 })); // í•˜ë‹¨ 80-100%

    useEffect(() => {
        // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ì²´í¬
        if (hasPlayed) return;

        const handleImageLoad = () => {
            // ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ ì§€ì •ëœ ì‹œê°„ë§Œí¼ ëŒ€ê¸° í›„ ì½œë°± ì‹¤í–‰
            timeoutRef.current = setTimeout(() => {
                setHasPlayed(true);
                onComplete?.();
            }, duration);
        };
```

**ë°ì´í„° íë¦„**:
- ì‹œì‘ ë¡œë”© GIF ì´ë¯¸ì§€ í‘œì‹œ
- 3ì´ˆ í›„ `onComplete` ì½œë°± í˜¸ì¶œ

**ì €ì¥ ìœ„ì¹˜**: ì—†ìŒ (UI ìƒíƒœë§Œ)

---

### 1.3 ì§€ê°‘ ìƒíƒœ ì´ˆê¸° í™•ì¸

**ìœ„ì¹˜**: `frontend/src/sidepanel/hooks/useSidepanelWallet.ts`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰)

**ì½”ë“œ ë™ì‘**:

```74:82:frontend/src/sidepanel/hooks/useSidepanelWallet.ts
    // ì´ˆê¸° ìƒíƒœ í™•ì¸ (ë§ˆìš´íŠ¸ ì‹œ í•œ ë²ˆë§Œ)
    useEffect(() => {
        if (initialCheckDone.current) {
            return;
        }
        initialCheckDone.current = true;
        checkAccount();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);
```

**ë°ì´í„° íë¦„**:
1. `checkAccount()` í˜¸ì¶œ
2. `backgroundApi.walletGetAccount()` â†’ Background Scriptë¡œ ë©”ì‹œì§€ ì „ì†¡
3. Background Scriptê°€ Content Scriptë¥¼ í†µí•´ MetaMask í™•ì¸
4. ê²°ê³¼ ë°˜í™˜: `{ isConnected: boolean, address: string | null }`
5. `setWalletConnectedAtom`ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸

**ì €ì¥ ìœ„ì¹˜**: 
- `sessionAtom.walletAddress`
- `sessionAtom.isWalletConnected`
- ì €ì¥ì†Œ: `sessionStorage['squid_session_state']`

---

### 1.4 MEMEX ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸° í™•ì¸

**ìœ„ì¹˜**: `frontend/src/sidepanel/hooks/useMemexLogin.ts`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰)

**ì½”ë“œ ë™ì‘**:

```207:261:frontend/src/sidepanel/hooks/useMemexLogin.ts
  // ì•± ì‹œì‘ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (Jotai atomWithStorageê°€ ìë™ìœ¼ë¡œ ì €ì¥ì†Œì—ì„œ ë¶ˆëŸ¬ì˜´)
  useEffect(() => {
    // ì´ë¯¸ ì²´í¬ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ìŠ¤í‚µ
    if (loginCheckCompleted) {
      return;
    }

    const performCheck = async () => {
      // ê¸°ì¡´ ì„¸ì…˜ì— username/userTagê°€ ìˆì–´ë„ ë°±ì—”ë“œ í†µì‹  í•„ìš” (ì¶œì„ ì²´í¬)
      if (username && userTag) {
        console.log("ğŸ” [useMemexLogin] ê¸°ì¡´ ì„¸ì…˜ ë°ì´í„°ë¡œ ë°±ì—”ë“œ ì¡°íšŒ:", {
          username,
          userTag,
        });

        try {
          const result = await backgroundApi.getUserByUsername(
            username,
            userTag
          );

          if (result.user) {
            setUser(result.user);
            setMemexLoggedIn({
              isLoggedIn: true,
              username: result.user.userName,
              userTag: result.user.userTag,
              profileImage: result.user.profileImage,
            });
            console.log(
              "âœ… [useMemexLogin] ê¸°ì¡´ ì„¸ì…˜ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì™„ë£Œ:",
              result.user
            );
          } else {
            // ë°±ì—”ë“œì— ìœ ì €ê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ìƒíƒœ false
            setMemexLoggedIn({ isLoggedIn: false });
          }
        } catch (err) {
          console.warn(
            "âš ï¸ [useMemexLogin] ê¸°ì¡´ ì„¸ì…˜ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:",
            err
          );
          setMemexLoggedIn({ isLoggedIn: false });
        }
      } else {
        // username/userTagê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ checkLoginStatus ì‹¤í–‰
        await checkLoginStatus();
      }

      setLoginCheckCompleted(true);
    };

    performCheck();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [loginCheckCompleted, username, userTag, setLoginCheckCompleted]);
```

**ë°ì´í„° íë¦„**:
1. `sessionStorage`ì—ì„œ ê¸°ì¡´ `username`, `userTag` í™•ì¸
2. ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´:
   - `backgroundApi.getUserByUsername()` í˜¸ì¶œ
   - ë°±ì—”ë“œì—ì„œ ìµœì‹  user ì •ë³´ ì¡°íšŒ (ì¶œì„ ì²´í¬ í¬í•¨)
   - `setUser()` ë° `setMemexLoggedIn()`ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸
3. ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ìœ¼ë©´:
   - `checkLoginStatus()` ì‹¤í–‰ (GTM í‚¤ í™•ì¸)

**ì €ì¥ ìœ„ì¹˜**:
- `sessionAtom.isMemexLoggedIn`
- `sessionAtom.memexUsername`
- `sessionAtom.memexUserTag`
- `sessionAtom.user`
- ì €ì¥ì†Œ: `sessionStorage['squid_session_state']`

---

## 2. ComingSoon í™”ë©´ í‘œì‹œ

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ í‘œì‹œ)

**ì½”ë“œ ë™ì‘**:

```396:429:frontend/src/sidepanel/ComingSoon.tsx
    return (
        <div className="coming-soon-container">
            {/* Background Images - Dashboardì™€ ë™ì¼ */}
            <div className="dashboard-background">
                <img src={homeBg} alt="Background" className="bg-image" />
                <img src={homeFloor} alt="Floor" className="floor-image" />
            </div>

            {/* ì¤‘ìƒë‹¨: ì´ë¯¸ì§€ ë¯¸ ë¡œê·¸ */}
            <div className="image-milog-text">
                ì´ë¯¸ì§€ ë¯¸ ë¡œê·¸
            </div>

            {/* ë¡œë”© ìƒíƒœ í‘œì‹œ */}
            {isLoggingIn && (
                <div className="loading-overlay">
                    <div className="loading-spinner"></div>
                    <p className="loading-text">Loading...</p>
                </div>
            )}

            {/* í•˜ë‹¨ ì¤‘ì•™: CONNECT ë²„íŠ¼ */}
            {!isLoggingIn && (
                <>
                    <div className=""></div>
                    <button
                        className="connect-bottom-button"
                        onClick={handleConnect}
                        disabled={isLoading}
                    >
                        [ CONNECT {'>'}{'>'}{'>'} ]
                    </button>
                    <div className=""></div>
                </>
            )}
```

**ì¡°ê±´**: `isConnected && isMemexLoggedIn`ì´ `false`ì¸ ê²½ìš°

**ë°ì´í„° íë¦„**: UIë§Œ í‘œì‹œ, ë°ì´í„° ì¡°ì‘ ì—†ìŒ

---

## 3. ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œì‘

### 3.1 CONNECT ë²„íŠ¼ í´ë¦­

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: "[ CONNECT >>> ]" ë²„íŠ¼ í´ë¦­

**ì½”ë“œ ë™ì‘**:

```66:69:frontend/src/sidepanel/ComingSoon.tsx
    const handleConnect = () => {
        // ì•½ê´€ ë™ì˜ ëª¨ë‹¬ í‘œì‹œ
        setIsTermsModalOpen(true);
    };
```

**ë°ì´í„° íë¦„**:
- `isTermsModalOpen` ìƒíƒœë¥¼ `true`ë¡œ ë³€ê²½
- TermsModal ì»´í¬ë„ŒíŠ¸ê°€ í‘œì‹œë¨

**ì €ì¥ ìœ„ì¹˜**: ë¡œì»¬ React state (`useState`)

---

### 3.2 ì•½ê´€ ë™ì˜ ëª¨ë‹¬ í‘œì‹œ

**ìœ„ì¹˜**: `frontend/src/sidepanel/components/TermsModal.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ í‘œì‹œ)

**ì½”ë“œ ë™ì‘**:

```7:35:frontend/src/sidepanel/components/TermsModal.tsx
export function TermsModal({ isOpen, onClose, onAgree }: TermsModalProps) {
    if (!isOpen) return null;

    return (
        <div className="terms-modal-overlay" onClick={onClose}>
            <div className="terms-modal" onClick={(e) => e.stopPropagation()}>
                <h2 className="terms-modal-title">Agreement Required</h2>
                <div className="terms-modal-text">
                    I AGREE TO THE{" "}
                    <a href="#" className="terms-link" onClick={(e) => e.preventDefault()}>
                        TERMS OF SERVICE
                    </a>{" "}
                    AND{" "}
                    <a href="#" className="terms-link" onClick={(e) => e.preventDefault()}>
                        PRIVACY POLICY
                    </a>
                </div>
                <div className="terms-modal-footer">
                    <button className="terms-btn terms-btn-decline" onClick={onClose}>
                        I Decline
                    </button>
                    <button className="terms-btn terms-btn-agree" onClick={onAgree}>
                        I Agree
                    </button>
                </div>
            </div>
        </div>
    );
}
```

**ë°ì´í„° íë¦„**: UIë§Œ í‘œì‹œ, ë°ì´í„° ì¡°ì‘ ì—†ìŒ

---

### 3.3 ì•½ê´€ ë™ì˜ ë²„íŠ¼ í´ë¦­

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: "I Agree" ë²„íŠ¼ í´ë¦­

**ì½”ë“œ ë™ì‘**:

```75:91:frontend/src/sidepanel/ComingSoon.tsx
    const handleAgreeTerms = async () => {
        setIsTermsModalOpen(false);
        try {
            // 1. ì§€ê°‘ ì—°ê²°
            if (!isConnected) {
                await connect();
            }

            // 2. ì§€ê°‘ ì—°ê²° í›„ MEMEX ë¡œê·¸ì¸ ì‹œì‘
            await handleMemexLogin();
        } catch (err) {
            console.error("Connection failed:", err);
            if (isContentScriptError(err)) {
                showRefreshSnackbar();
            }
        }
    };
```

**ë°ì´í„° íë¦„**:
1. ì•½ê´€ ëª¨ë‹¬ ë‹«ê¸° (`setIsTermsModalOpen(false)`)
2. ì§€ê°‘ ì—°ê²° ìƒíƒœ í™•ì¸
3. ì—°ê²°ë˜ì§€ ì•Šì•˜ìœ¼ë©´ `connect()` í˜¸ì¶œ
4. ì§€ê°‘ ì—°ê²° í›„ `handleMemexLogin()` í˜¸ì¶œ

---

### 3.4 ì§€ê°‘ ì—°ê²° í”„ë¡œì„¸ìŠ¤

**ìœ„ì¹˜**: `frontend/src/sidepanel/hooks/useSidepanelWallet.ts`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰, MetaMask ìŠ¹ì¸ í•„ìš”)

**ì½”ë“œ ë™ì‘**:

```84:104:frontend/src/sidepanel/hooks/useSidepanelWallet.ts
    const handleConnect = useCallback(async () => {
        console.log('ğŸ” [SidePanel] handleConnect ì‹œì‘');
        setLoading(true);
        setError(null);

        try {
            console.log('ğŸ” [SidePanel] backgroundApi.walletConnect() í˜¸ì¶œ');
            const result = await backgroundApi.walletConnect();
            console.log('ğŸ” [SidePanel] walletConnect ê²°ê³¼:', result);

            setWalletConnected({ isConnected: true, address: result.address });
            setLoading(false);
            setError(null);
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'Failed to connect wallet';
            console.error('âŒ [SidePanel] Wallet connection error:', err);
            setLoading(false);
            setError(errorMessage);
            throw err; // í˜¸ì¶œìê°€ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë‹¤ì‹œ throw
        }
    }, [setWalletConnected, setLoading, setError]);
```

**ë°ì´í„° íë¦„**:

1. **SidePanel â†’ Background Script**:
   - `backgroundApi.walletConnect()` í˜¸ì¶œ
   - ë©”ì‹œì§€ íƒ€ì…: `WALLET_CONNECT`

2. **Background Script â†’ Content Script â†’ Injected Script â†’ MetaMask**:
   - MEMEX ì›¹ì‚¬ì´íŠ¸ì˜ injected scriptê°€ MetaMaskì— ì—°ê²° ìš”ì²­
   - MetaMask íŒì—…ì—ì„œ ì‚¬ìš©ì ìŠ¹ì¸ ëŒ€ê¸°

3. **MetaMask â†’ Injected Script â†’ Content Script â†’ Background Script â†’ SidePanel**:
   - ì—°ê²°ëœ ì§€ê°‘ ì£¼ì†Œ ë°˜í™˜: `{ address: string }`

4. **ìƒíƒœ ì—…ë°ì´íŠ¸**:
   - `setWalletConnectedAtom({ isConnected: true, address })`

**ì €ì¥ ìœ„ì¹˜**:
- `sessionAtom.walletAddress`
- `sessionAtom.isWalletConnected`
- ì €ì¥ì†Œ: `sessionStorage['squid_session_state']`

---

## 4. MEMEX ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤

### 4.1 MEMEX ë¡œê·¸ì¸ ì‹œì‘

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰)

**ì½”ë“œ ë™ì‘**:

```93:181:frontend/src/sidepanel/ComingSoon.tsx
    const handleMemexLogin = async () => {
        try {
            console.log("ğŸ” MEMEX login started...");

            // 1. GTM í‚¤ ë¨¼ì € ì²´í¬
            const cachedUserInfo = await getMemexUserInfo();

            if (cachedUserInfo) {
                // GTM í‚¤ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ë°±ì—”ë“œì—ì„œ user ì •ë³´ ì¡°íšŒ
                console.log("âœ… GTM í‚¤ ë°œê²¬, ë°±ì—”ë“œì—ì„œ user ì¡°íšŒ:", cachedUserInfo);
                setLoggingIn(true);

                try {
                    // ë°±ì—”ë“œì—ì„œ user ì •ë³´ ì¡°íšŒ
                    const checkResult = (await backgroundApi.getUserByUsername(
                        cachedUserInfo.username,
                        cachedUserInfo.user_tag
                    )) as { user: User | null };

                    if (checkResult?.user && onMemexLoginComplete) {
                        console.log("âœ… MEMEX ë¡œê·¸ì¸ ì™„ë£Œ:", checkResult.user.userName);
                        setUser(checkResult.user);
                        setLoggingIn(false);
                        await refetch();
                        onMemexLoginComplete(cachedUserInfo.username, cachedUserInfo.user_tag);
                        return;
                    }

                    // ë°±ì—”ë“œì— userê°€ ì—†ìœ¼ë©´ ì‹ ê·œ ì‚¬ìš©ì - ìë™ íšŒì›ê°€ì… ì‹œë„
                    console.log("ğŸ†• [cachedUserInfo] ë°±ì—”ë“œì— user ì—†ìŒ, ìë™ íšŒì›ê°€ì… ì‹œë„...");

                    // 1. í”„ë¡œí•„ ì •ë³´ fetch
                    const profileInfo = await backgroundApi.fetchMemexProfileInfo(
                        cachedUserInfo.username,
                        cachedUserInfo.user_tag
                    );
                    console.log("ğŸ“‹ [cachedUserInfo] í”„ë¡œí•„ ì •ë³´:", profileInfo);

                    // 2. ì§€ê°‘ ì£¼ì†Œ í™•ì¸
                    if (!address) {
                        console.warn("âš ï¸ [cachedUserInfo] ì§€ê°‘ ì—°ê²° í•„ìš”");
                        setLoggingIn(false);
                        // ì§€ê°‘ ë¯¸ì—°ê²° ìƒíƒœì—ì„œëŠ” memexLoginìœ¼ë¡œ ê³„ì† ì§„í–‰
                    } else if (profileInfo?.profileImageUrl && profileInfo?.tokenAddr && profileInfo?.memexWalletAddress) {
                        // 3. í•„ìˆ˜ ì •ë³´ í™•ì¸ í›„ Join ìš”ì²­
                        const joinResult = await backgroundApi.join({
                            username: cachedUserInfo.username,
                            userTag: cachedUserInfo.user_tag,
                            walletAddress: address,
                            profileImageUrl: profileInfo.profileImageUrl,
                            memeXLink: `https://app.memex.xyz/profile/${cachedUserInfo.username}/${cachedUserInfo.user_tag}`,
                            myTokenAddr: profileInfo.tokenAddr,
                            myTokenSymbol: profileInfo.tokenSymbol || "",
                            memexWalletAddress: profileInfo.memexWalletAddress,
                            isPolicyAgreed: true,
                        });

                        if (joinResult?.user && onMemexLoginComplete) {
                            setUser(joinResult.user);
                            console.log("âœ… [cachedUserInfo] ìë™ íšŒì›ê°€ì… ì™„ë£Œ:", joinResult.user.userName);
                            setLoggingIn(false);
                            await refetch();
                            onMemexLoginComplete(cachedUserInfo.username, cachedUserInfo.user_tag);
                            return;
                        }
                    } else {
                        console.warn("âš ï¸ [cachedUserInfo] í”„ë¡œí•„ ì •ë³´ ë¶€ì¡±, íšŒì›ê°€ì… ë¶ˆê°€:", {
                            profileImageUrl: profileInfo?.profileImageUrl,
                            tokenAddr: profileInfo?.tokenAddr,
                            memexWalletAddress: profileInfo?.memexWalletAddress,
                        });
                    }

                    // íšŒì›ê°€ì… ì‹¤íŒ¨ ì‹œ memexLoginìœ¼ë¡œ ê³„ì† ì§„í–‰
                    console.log("âš ï¸ [cachedUserInfo] ìë™ íšŒì›ê°€ì… ì‹¤íŒ¨, memexLoginìœ¼ë¡œ ê³„ì† ì§„í–‰...");
                    setLoggingIn(false);
                } catch (err) {
                    console.error("âŒ [cachedUserInfo] ì²˜ë¦¬ ì‹¤íŒ¨:", err);
                    setLoggingIn(false);
                    if (isContentScriptError(err)) {
                        showRefreshSnackbar();
                        return;
                    }
                }
            } else {
                // GTM í‚¤ê°€ ì—†ìœ¼ë©´ app.memex.xyzë¡œ ì´ë™í•˜ì—¬ Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
                console.log("ğŸ” GTM í‚¤ ì—†ìŒ, Google ë¡œê·¸ì¸ ì‹œì‘...");
            }
```

**ë°ì´í„° íë¦„**:

1. **GTM í‚¤ í™•ì¸**:
   - `getMemexUserInfo()` í˜¸ì¶œ
   - `sessionStorage['gtm_user_identifier']`ì—ì„œ username, userTag ì½ê¸°

2. **ê²½ë¡œ A: GTM í‚¤ê°€ ìˆëŠ” ê²½ìš°**:
   - ë°±ì—”ë“œì—ì„œ user ì •ë³´ ì¡°íšŒ
   - ìˆìœ¼ë©´: ë¡œê·¸ì¸ ì™„ë£Œ
   - ì—†ìœ¼ë©´: ìë™ íšŒì›ê°€ì… ì‹œë„ (í”„ë¡œí•„ ì •ë³´ fetch â†’ Join ìš”ì²­)

3. **ê²½ë¡œ B: GTM í‚¤ê°€ ì—†ëŠ” ê²½ìš°**:
   - Google ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (4.2ë¡œ ì´ë™)

---

### 4.2 GTM í‚¤ê°€ ì—†ëŠ” ê²½ìš°: Google ë¡œê·¸ì¸ ì‹œì‘

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰, MEMEX ì›¹ì‚¬ì´íŠ¸ì—ì„œ Google ë¡œê·¸ì¸ í•„ìš”)

**ì½”ë“œ ë™ì‘**:

```182:202:frontend/src/sidepanel/ComingSoon.tsx
            // 2. GTM í‚¤ê°€ ì—†ê±°ë‚˜, ìˆì–´ë„ í”„ë¡œí•„ì—ì„œ ë¡œê·¸ì¸ í™•ì¸ ì‹¤íŒ¨ ì‹œ Google ë¡œê·¸ì¸ ì‹œë„
            const result = (await backgroundApi.memexLogin(true)) as {
                success: boolean;
                isLoggedIn?: boolean;
                loginStarted?: boolean;
                username?: string;
                userTag?: string;
                error?: string;
            };
            console.log("ğŸ” MEMEX login result:", result);

            // Content script ì—°ê²° ì˜¤ë¥˜ ì²´í¬ (ì‘ë‹µì— error í•„ë“œê°€ ìˆëŠ” ê²½ìš°)
            if (
                result?.error &&
                (result.error.toLowerCase().includes("receiving end does not exist") ||
                    result.error.toLowerCase().includes("could not establish connection"))
            ) {
                console.log("âš ï¸ Content script ì—°ê²° ì˜¤ë¥˜, ìŠ¤ë‚µë°” í‘œì‹œ");
                showRefreshSnackbar();
                return;
            }
```

**ë°ì´í„° íë¦„**:

1. **SidePanel â†’ Background Script**:
   - `backgroundApi.memexLogin(true)` í˜¸ì¶œ (`triggerLogin: true`)
   - ë©”ì‹œì§€ íƒ€ì…: `MEMEX_LOGIN`

2. **Background Script â†’ Content Script**:
   - MEMEX ì›¹ì‚¬ì´íŠ¸ íƒ­ì˜ content scriptë¡œ ë©”ì‹œì§€ ì „ë‹¬

3. **Content Script â†’ MEMEX ì›¹ì‚¬ì´íŠ¸**:
   - `app.memex.xyz`ì—ì„œ Google ë¡œê·¸ì¸ ë²„íŠ¼ ì°¾ê¸°
   - ë²„íŠ¼ì´ ì—†ìœ¼ë©´ íƒ­ ì´ë™ (`app.memex.xyz`ë¡œ ì´ë™)
   - Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜

4. **ì‘ë‹µ ë°˜í™˜**:
   - `{ loginStarted: true }` - ë¡œê·¸ì¸ ì‹œì‘ë¨
   - `{ isLoggedIn: true, username, userTag }` - ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìŒ
   - `{ error: string }` - ì—ëŸ¬ ë°œìƒ (ì˜ˆ: MEMEX íƒ­ì´ ì—†ìŒ)

**ì €ì¥ ìœ„ì¹˜**: ì—†ìŒ (ë¹„ë™ê¸° ì²˜ë¦¬)

---

### 4.3 ë¡œê·¸ì¸ ì™„ë£Œ í™•ì¸ (ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš°)

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ í™•ì¸)

**ì½”ë“œ ë™ì‘**:

```204:271:frontend/src/sidepanel/ComingSoon.tsx
            // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ë°±ì—”ë“œì—ì„œ user ì •ë³´ ì¡°íšŒ í›„ ì™„ë£Œ
            if (result?.isLoggedIn && result.username && result.userTag && onMemexLoginComplete) {
                console.log("ğŸ” GTM ë¡œê·¸ì¸ í™•ì¸ë¨, ë°±ì—”ë“œì—ì„œ user ì •ë³´ ì¡°íšŒ:", result.username);
                try {
                    const userResult = await backgroundApi.getUserByUsername(
                        result.username,
                        result.userTag
                    );
                    if (userResult?.user) {
                        setUser(userResult.user);
                        console.log("âœ… MEMEX ë¡œê·¸ì¸ ì™„ë£Œ:", userResult.user.userName);
                        setLoggingIn(false);
                        onMemexLoginComplete(result.username, result.userTag);
                        return;
                    }

                    // ë°±ì—”ë“œì— userê°€ ì—†ìœ¼ë©´ ì‹ ê·œ ì‚¬ìš©ì - ìë™ íšŒì›ê°€ì… ì‹œë„
                    console.log("ğŸ†• ë°±ì—”ë“œì— user ì—†ìŒ, ìë™ íšŒì›ê°€ì… ì‹œë„...");
                    setLoggingIn(true);

                    // 1. í”„ë¡œí•„ ì •ë³´ fetch
                    const profileInfo = await backgroundApi.fetchMemexProfileInfo(
                        result.username,
                        result.userTag
                    );
                    console.log("ğŸ“‹ í”„ë¡œí•„ ì •ë³´:", profileInfo);

                    // 2. ì§€ê°‘ ì£¼ì†Œ í™•ì¸
                    if (!address) {
                        console.warn("âš ï¸ ì§€ê°‘ ì—°ê²° í•„ìš”");
                        setLoggingIn(false);
                        return;
                    }

                    // 3. í•„ìˆ˜ ì •ë³´ í™•ì¸ í›„ Join ìš”ì²­
                    if (profileInfo?.profileImageUrl && profileInfo?.tokenAddr && profileInfo?.memexWalletAddress) {
                        const joinResult = await backgroundApi.join({
                            username: result.username,
                            userTag: result.userTag,
                            walletAddress: address,
                            profileImageUrl: profileInfo.profileImageUrl,
                            memeXLink: `https://app.memex.xyz/profile/${result.username}/${result.userTag}`,
                            myTokenAddr: profileInfo.tokenAddr,
                            myTokenSymbol: profileInfo.tokenSymbol || "",
                            memexWalletAddress: profileInfo.memexWalletAddress,
                            isPolicyAgreed: true,
                        });

                        if (joinResult?.user) {
                            setUser(joinResult.user);
                            console.log("âœ… ìë™ íšŒì›ê°€ì… ì™„ë£Œ:", joinResult.user.userName);
                            setLoggingIn(false);
                            onMemexLoginComplete(result.username, result.userTag);
                            return;
                        }
                    } else {
                        console.warn("âš ï¸ í”„ë¡œí•„ ì •ë³´ ë¶€ì¡±, íšŒì›ê°€ì… ë¶ˆê°€:", {
                            profileImageUrl: profileInfo?.profileImageUrl,
                            tokenAddr: profileInfo?.tokenAddr,
                            memexWalletAddress: profileInfo?.memexWalletAddress,
                        });
                    }
                    setLoggingIn(false);
                } catch (userErr) {
                    console.warn("âš ï¸ User ì •ë³´ ì¡°íšŒ/íšŒì›ê°€ì… ì‹¤íŒ¨:", userErr);
                    setLoggingIn(false);
                }
            }
```

**ë°ì´í„° íë¦„**:

1. **ë°±ì—”ë“œì—ì„œ user ì¡°íšŒ**:
   - `backgroundApi.getUserByUsername(username, userTag)`
   - API í˜¸ì¶œ: `GET /api/users/by-username?username=...&userTag=...`

2. **userê°€ ìˆëŠ” ê²½ìš°**:
   - `setUser(userResult.user)` - user ì •ë³´ ì €ì¥
   - `onMemexLoginComplete()` í˜¸ì¶œ

3. **userê°€ ì—†ëŠ” ê²½ìš° (ì‹ ê·œ ì‚¬ìš©ì)**:
   - í”„ë¡œí•„ ì •ë³´ fetch â†’ Join ìš”ì²­ (4.5ë¡œ ì´ë™)

**ì €ì¥ ìœ„ì¹˜**:
- `sessionAtom.user` - ë°±ì—”ë“œì—ì„œ ë°›ì€ User ê°ì²´
- ì €ì¥ì†Œ: `sessionStorage['squid_session_state']`

---

### 4.4 ë¡œê·¸ì¸ ì‹œì‘ í›„ í´ë§ (Google ë¡œê·¸ì¸ ì§„í–‰ ì¤‘)

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: MEMEX ì›¹ì‚¬ì´íŠ¸ì—ì„œ Google ë¡œê·¸ì¸ ì™„ë£Œ

**ì½”ë“œ ë™ì‘**:

```273:381:frontend/src/sidepanel/ComingSoon.tsx
            // ë¡œê·¸ì¸ ì‹œì‘ë¨ - í´ë§ìœ¼ë¡œ ë¡œê·¸ì¸ ì™„ë£Œ í™•ì¸
            if (result?.loginStarted) {
                console.log("ğŸ” Google ë¡œê·¸ì¸ ì‹œì‘ë¨, í´ë§ ì‹œì‘...");
                setLoggingIn(true);
                const maxWaitTime = 60000; // 60ì´ˆ
                const pollInterval = 2000; // 2ì´ˆ
                const startTime = Date.now();

                const checkLoginStatus = async (): Promise<void> => {
                    const elapsed = Date.now() - startTime;
                    if (elapsed >= maxWaitTime) {
                        console.error("âŒ ë¡œê·¸ì¸ íƒ€ì„ì•„ì›ƒ");
                        setLoggingIn(false);
                        return;
                    }

                    try {
                        const checkResult = (await backgroundApi.memexLogin()) as {
                            success: boolean;
                            isLoggedIn?: boolean;
                            username?: string;
                            userTag?: string;
                        };
                        console.log(
                            "ğŸ” ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸:",
                            checkResult,
                            Math.floor(elapsed / 1000),
                            "ì´ˆ ê²½ê³¼"
                        );

                        if (checkResult?.isLoggedIn && checkResult.username && checkResult.userTag && onMemexLoginComplete) {
                            console.log("ğŸ” GTM ë¡œê·¸ì¸ í™•ì¸ë¨, ë°±ì—”ë“œì—ì„œ user ì •ë³´ ì¡°íšŒ:", checkResult.username);

                            // ë°±ì—”ë“œì—ì„œ user ì •ë³´ ê°€ì ¸ì˜¤ê¸° - userê°€ ìˆì–´ì•¼ë§Œ ë¡œê·¸ì¸ ì™„ë£Œ
                            try {
                                const userResult = await backgroundApi.getUserByUsername(
                                    checkResult.username,
                                    checkResult.userTag
                                );
                                if (userResult?.user) {
                                    setUser(userResult.user);
                                    console.log("âœ… MEMEX ë¡œê·¸ì¸ ì™„ë£Œ:", userResult.user.userName);
                                    setLoggingIn(false);
                                    await refetch();
                                    onMemexLoginComplete(checkResult.username, checkResult.userTag);
                                    return;
                                }

                                // ë°±ì—”ë“œì— user ì—†ìŒ - ìë™ íšŒì›ê°€ì… ì‹œë„
                                console.log("ğŸ†• ë°±ì—”ë“œì— user ì—†ìŒ, ìë™ íšŒì›ê°€ì… ì‹œë„...");

                                // 1. í”„ë¡œí•„ ì •ë³´ fetch
                                const profileInfo = await backgroundApi.fetchMemexProfileInfo(
                                    checkResult.username,
                                    checkResult.userTag
                                );
                                console.log("ğŸ“‹ í”„ë¡œí•„ ì •ë³´:", profileInfo);

                                // 2. ì§€ê°‘ ì£¼ì†Œ í™•ì¸
                                if (!address) {
                                    console.warn("âš ï¸ ì§€ê°‘ ì—°ê²° í•„ìš”, í´ë§ ê³„ì†...");
                                    setTimeout(checkLoginStatus, pollInterval);
                                    return;
                                }

                                // 3. í•„ìˆ˜ ì •ë³´ í™•ì¸ í›„ Join ìš”ì²­
                                if (profileInfo?.profileImageUrl && profileInfo?.tokenAddr && profileInfo?.memexWalletAddress) {
                                    const joinResult = await backgroundApi.join({
                                        username: checkResult.username,
                                        userTag: checkResult.userTag,
                                        walletAddress: address,
                                        profileImageUrl: profileInfo.profileImageUrl,
                                        memeXLink: `https://app.memex.xyz/profile/${checkResult.username}/${checkResult.userTag}`,
                                        myTokenAddr: profileInfo.tokenAddr,
                                        myTokenSymbol: profileInfo.tokenSymbol || "",
                                        memexWalletAddress: profileInfo.memexWalletAddress,
                                        isPolicyAgreed: true,
                                    });

                                    if (joinResult?.user) {
                                        setUser(joinResult.user);
                                        console.log("âœ… ìë™ íšŒì›ê°€ì… ì™„ë£Œ:", joinResult.user.userName);
                                        setLoggingIn(false);
                                        await refetch();
                                        onMemexLoginComplete(checkResult.username, checkResult.userTag);
                                        return;
                                    }
                                } else {
                                    console.warn("âš ï¸ í”„ë¡œí•„ ì •ë³´ ë¶€ì¡±, í´ë§ ê³„ì†:", {
                                        profileImageUrl: profileInfo?.profileImageUrl,
                                        tokenAddr: profileInfo?.tokenAddr,
                                        memexWalletAddress: profileInfo?.memexWalletAddress,
                                    });
                                }
                            } catch (userErr) {
                                console.warn("âš ï¸ User ì •ë³´ ì¡°íšŒ/íšŒì›ê°€ì… ì‹¤íŒ¨, í´ë§ ê³„ì†:", userErr);
                            }
                        }

                        // ì•„ì§ ë¡œê·¸ì¸ ì•ˆë¨, ë‹¤ì‹œ ì²´í¬
                        setTimeout(checkLoginStatus, pollInterval);
                    } catch (err) {
                        console.log("ğŸ” ë¡œê·¸ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ (ì¬ì‹œë„):", err);
                        setTimeout(checkLoginStatus, pollInterval);
                    }
                };

                // 5ì´ˆ í›„ í´ë§ ì‹œì‘ (Google ë¡œê·¸ì¸ ì™„ë£Œ ì‹œê°„ ëŒ€ê¸°)
                setTimeout(checkLoginStatus, 5000);
            }
```

**ë°ì´í„° íë¦„**:

1. **í´ë§ ì‹œì‘**:
   - 5ì´ˆ ëŒ€ê¸° í›„ ì²« í´ë§ ì‹œì‘
   - ì´í›„ 2ì´ˆë§ˆë‹¤ ë°˜ë³µ (ìµœëŒ€ 60ì´ˆ)

2. **ê° í´ë§ë§ˆë‹¤**:
   - `backgroundApi.memexLogin()` í˜¸ì¶œ (triggerLogin: false)
   - MEMEX ì›¹ì‚¬ì´íŠ¸ì˜ `sessionStorage['gtm_user_identifier']` í™•ì¸
   - GTM í‚¤ê°€ ìˆìœ¼ë©´: `{ isLoggedIn: true, username, userTag }` ë°˜í™˜

3. **ë¡œê·¸ì¸ í™•ì¸ë˜ë©´**:
   - ë°±ì—”ë“œì—ì„œ user ì¡°íšŒ
   - ìˆìœ¼ë©´: ë¡œê·¸ì¸ ì™„ë£Œ
   - ì—†ìœ¼ë©´: ìë™ íšŒì›ê°€ì… ì‹œë„

**ì €ì¥ ìœ„ì¹˜**: ì—†ìŒ (í´ë§ ì¤‘)

---

### 4.5 ìë™ íšŒì›ê°€ì… (ì‹ ê·œ ì‚¬ìš©ì)

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰)

**ì½”ë“œ ë™ì‘**:

íšŒì›ê°€ì…ì€ ë‹¤ìŒ 3ë‹¨ê³„ë¡œ ì§„í–‰ë©ë‹ˆë‹¤:

1. **í”„ë¡œí•„ ì •ë³´ Fetch**:
```typescript
const profileInfo = await backgroundApi.fetchMemexProfileInfo(
    username,
    userTag
);
```

2. **ì§€ê°‘ ì£¼ì†Œ í™•ì¸**:
```typescript
if (!address) {
    // ì§€ê°‘ ë¯¸ì—°ê²° ì‹œ ì—ëŸ¬ ë˜ëŠ” ëŒ€ê¸°
    return;
}
```

3. **Join ìš”ì²­**:
```typescript
const joinResult = await backgroundApi.join({
    username: cachedUserInfo.username,
    userTag: cachedUserInfo.user_tag,
    walletAddress: address,
    profileImageUrl: profileInfo.profileImageUrl,
    memeXLink: `https://app.memex.xyz/profile/${username}/${userTag}`,
    myTokenAddr: profileInfo.tokenAddr,
    myTokenSymbol: profileInfo.tokenSymbol || "",
    memexWalletAddress: profileInfo.memexWalletAddress,
    isPolicyAgreed: true,
});
```

**ë°ì´í„° íë¦„**:

#### 4.5.1 í”„ë¡œí•„ ì •ë³´ Fetch

1. **SidePanel â†’ Background Script**:
   - `backgroundApi.fetchMemexProfileInfo(username, userTag)`
   - ë©”ì‹œì§€ íƒ€ì…: `FETCH_MEMEX_PROFILE_INFO`

2. **Background Script â†’ Content Script â†’ MEMEX ì›¹ì‚¬ì´íŠ¸**:
   - MEMEX í”„ë¡œí•„ í˜ì´ì§€ (`app.memex.xyz/profile/${username}/${userTag}`) ë°©ë¬¸
   - DOMì—ì„œ ë‹¤ìŒ ì •ë³´ ì¶”ì¶œ:
     - í”„ë¡œí•„ ì´ë¯¸ì§€ URL
     - í† í° ì£¼ì†Œ (`myTokenAddr`)
     - í† í° ì‹¬ë³¼ (`myTokenSymbol`)
     - í† í° ì´ë¯¸ì§€ URL
     - MEMEX ì§€ê°‘ ì£¼ì†Œ (`memexWalletAddress`)

3. **ì‘ë‹µ ë°˜í™˜**:
```typescript
{
    profileImageUrl: string | null;
    tokenAddr: string | null;
    tokenSymbol: string | null;
    tokenImageUrl: string | null;
    memexWalletAddress: string | null;
}
```

#### 4.5.2 Join ìš”ì²­

1. **SidePanel â†’ Background Script**:
   - `backgroundApi.join(joinData)`
   - ë©”ì‹œì§€ íƒ€ì…: `JOIN`

2. **Background Script â†’ ë°±ì—”ë“œ API**:
   - `POST /api/users/join`
   - ìš”ì²­ ë³¸ë¬¸:
```json
{
    "username": string,
    "userTag": string,
    "walletAddress": string,
    "profileImageUrl": string,
    "memeXLink": string,
    "myTokenAddr": string,
    "myTokenSymbol": string,
    "memexWalletAddress": string,
    "isPolicyAgreed": boolean
}
```

3. **ë°±ì—”ë“œ ì²˜ë¦¬**:
   - ì‚¬ìš©ì ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
   - ì¶œì„ ì²´í¬ (ì˜¤ëŠ˜ ì²« ë¡œê·¸ì¸ ì‹œ)

4. **ì‘ë‹µ ë°˜í™˜**:
```typescript
{
    user: User; // User ê°ì²´
}
```

5. **ìƒíƒœ ì—…ë°ì´íŠ¸**:
   - `setUser(joinResult.user)`

**ì €ì¥ ìœ„ì¹˜**:
- ë°±ì—”ë“œ ë°ì´í„°ë² ì´ìŠ¤ (PostgreSQL)
- `sessionAtom.user` - ë°±ì—”ë“œì—ì„œ ë°›ì€ User ê°ì²´
- ì €ì¥ì†Œ: `sessionStorage['squid_session_state']`

---

### 4.6 useMemexLoginì˜ ìë™ Join ì²˜ë¦¬

**ìœ„ì¹˜**: `frontend/src/sidepanel/hooks/useMemexLogin.ts`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰)

**ì½”ë“œ ë™ì‘**:

ëª¨ë“  í•„ìˆ˜ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ Join ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤:

```263:297:frontend/src/sidepanel/hooks/useMemexLogin.ts
  // sessionStoreì˜ ëª¨ë“  í•„ìˆ˜ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ Join ìš”ì²­
  useEffect(() => {
    // ì´ë¯¸ User ì •ë³´ê°€ ìˆê±°ë‚˜ ìš”ì²­ ì¤‘ì´ë©´ ìŠ¤í‚µ
    if (user || joinRequestInProgress) {
      return;
    }

    // ëª¨ë“  í•„ìˆ˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const allDataReady =
      isLoggedIn &&
      username &&
      userTag &&
      walletAddress &&
      profileImageUrl &&
      myTokenAddr &&
      myTokenSymbol &&
      memexWalletAddress;

    if (allDataReady) {
      console.log("âœ… [useMemexLogin] ëª¨ë“  ë°ì´í„° ì¤€ë¹„ë¨, Join ìš”ì²­ ì‹œì‘");
      sendJoinRequest();
    }
    // sendJoinRequestëŠ” useCallbackìœ¼ë¡œ ë©”ëª¨ì´ì œì´ì…˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì˜ì¡´ì„±ì—ì„œ ì œì™¸
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    user,
    isLoggedIn,
    username,
    userTag,
    walletAddress,
    profileImageUrl,
    myTokenAddr,
    myTokenSymbol,
    memexWalletAddress,
  ]);
```

**ë°ì´í„° íë¦„**:

1. **ì¡°ê±´ í™•ì¸**:
   - `user`ê°€ ì—†ê³ 
   - `joinRequestInProgress`ê°€ `false`ì´ê³ 
   - ëª¨ë“  í•„ìˆ˜ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì–´ ìˆìœ¼ë©´

2. **Join ìš”ì²­ ì „ì†¡**:
   - `sendJoinRequest()` í˜¸ì¶œ
   - `backgroundApi.join()` ì‹¤í–‰

3. **ìƒíƒœ ì—…ë°ì´íŠ¸**:
   - `setUser(response.user)`

**ì €ì¥ ìœ„ì¹˜**:
- ë°±ì—”ë“œ ë°ì´í„°ë² ì´ìŠ¤
- `sessionAtom.user`
- ì €ì¥ì†Œ: `sessionStorage['squid_session_state']`

---

## 5. ë¡œê·¸ì¸ ì™„ë£Œ

### 5.1 ë¡œê·¸ì¸ ì™„ë£Œ ì½œë°± í˜¸ì¶œ

**ìœ„ì¹˜**: `frontend/src/sidepanel/ComingSoon.tsx` â†’ `frontend/src/sidepanel/App.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ ì‹¤í–‰)

**ì½”ë“œ ë™ì‘**:

```27:31:frontend/src/sidepanel/App.tsx
    // MEMEX ë¡œê·¸ì¸ ì™„ë£Œ í•¸ë“¤ëŸ¬
    const handleMemexLoginComplete = (username: string, userTag: string) => {
        console.log("ğŸ” [App] handleMemexLoginComplete í˜¸ì¶œë¨:", { username, userTag });
        setMemexLoggedIn(true, username, userTag);
    };
```

**ë°ì´í„° íë¦„**:

1. `onMemexLoginComplete(username, userTag)` í˜¸ì¶œ
2. `App.tsx`ì˜ `handleMemexLoginComplete()` ì‹¤í–‰
3. `setMemexLoggedIn(true, username, userTag)` í˜¸ì¶œ
4. `sessionAtom` ìƒíƒœ ì—…ë°ì´íŠ¸

**ì €ì¥ ìœ„ì¹˜**:
- `sessionAtom.isMemexLoggedIn = true`
- `sessionAtom.memexUsername = username`
- `sessionAtom.memexUserTag = userTag`
- ì €ì¥ì†Œ: `sessionStorage['squid_session_state']`

---

### 5.2 Dashboard í‘œì‹œ

**ìœ„ì¹˜**: `frontend/src/sidepanel/App.tsx`

**ìœ ì € ë™ì‘**: ì—†ìŒ (ìë™ í‘œì‹œ)

**ì½”ë“œ ë™ì‘**:

```44:95:frontend/src/sidepanel/App.tsx
    // ì§€ê°‘ ì—°ê²° + MEMEX ë¡œê·¸ì¸ ì™„ë£Œ ì‹œ ëŒ€ì‹œë³´ë“œ ë˜ëŠ” í”„ë¡œí•„
    if (isConnected && isMemexLoggedIn) {
        if (currentPage === "profile") {
            return (
                <ProfilePage
                    walletAddress={address || undefined}
                    onBack={() => setCurrentPage("dashboard")}
                    onNavigateToMyAssets={() => setCurrentPage("myAssets")}
                />
            );
        }
        if (currentPage === "leaderboard") {
            return (
                <LeaderboardPage
                    onBack={() => setCurrentPage("dashboard")}
                    onNavigateToProfile={() => setCurrentPage("profile")}
                />
            );
        }
        if (currentPage === "liveGames") {
            return (
                <LiveGamesPage
                    onBack={() => setCurrentPage("dashboard")}
                    onNavigateToProfile={() => setCurrentPage("profile")}
                />
            );
        }
        if (currentPage === "myAssets") {
            return (
                <MyAssetsPage
                    onBack={() => setCurrentPage("dashboard")}
                    onNavigateToProfile={() => setCurrentPage("profile")}
                />
            );
        }
        return (
            <Dashboard
                walletAddress={address || undefined}
                onNavigateToProfile={() => setCurrentPage("profile")}
                onNavigateToLeaderboard={() => setCurrentPage("leaderboard")}
                onNavigateToLiveGames={() => setCurrentPage("liveGames")}
                onNavigateToMyAssets={() => setCurrentPage("myAssets")}
                onNavigateToHowToPlay={() => {
                    // TODO: How to Play í˜ì´ì§€ êµ¬í˜„
                    console.log("How to Play clicked");
                }}
                onNavigateToQuest={() => {
                    // TODO: Quest í˜ì´ì§€ êµ¬í˜„
                    console.log("Quest clicked");
                }}
            />
        );
    }

    return <ComingSoon onMemexLoginComplete={handleMemexLoginComplete} />;
```

**ì¡°ê±´**: `isConnected && isMemexLoggedIn === true`

**ë°ì´í„° íë¦„**: Dashboard ì»´í¬ë„ŒíŠ¸ ë Œë”ë§

---

## 6. ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

### 6.1 ì „ì²´ ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤

```mermaid
sequenceDiagram
    participant User as ì‚¬ìš©ì
    participant App as App.tsx
    participant StartingLoading as StartingLoading
    participant ComingSoon as ComingSoon.tsx
    participant Wallet as useSidepanelWallet
    participant MemexLogin as useMemexLogin
    participant TermsModal as TermsModal
    participant Background as Background Script
    participant Content as Content Script
    participant Memex as MEMEX ì›¹ì‚¬ì´íŠ¸
    participant MetaMask as MetaMask
    participant Backend as ë°±ì—”ë“œ API

    Note over App,Backend: 1. ì•± ì´ˆê¸°í™”
    App->>StartingLoading: ë Œë”ë§ (3ì´ˆ)
    App->>Wallet: useSidepanelWallet() í›… í˜¸ì¶œ
    App->>MemexLogin: useMemexLogin() í›… í˜¸ì¶œ
    
    Wallet->>Background: walletGetAccount()
    Background->>Content: ì§€ê°‘ ìƒíƒœ í™•ì¸
    Content->>MetaMask: ê³„ì • ì¡°íšŒ
    MetaMask-->>Content: address ë°˜í™˜
    Content-->>Background: { address, isConnected }
    Background-->>Wallet: { address, isConnected }
    Wallet->>Wallet: setWalletConnectedAtom()
    
    MemexLogin->>MemexLogin: sessionStorageì—ì„œ username/userTag í™•ì¸
    alt ê¸°ì¡´ ì„¸ì…˜ ìˆìŒ
        MemexLogin->>Background: getUserByUsername(username, userTag)
        Background->>Backend: GET /api/users/by-username
        Backend-->>Background: User ê°ì²´
        Background-->>MemexLogin: { user: User }
        MemexLogin->>MemexLogin: setUser(), setMemexLoggedIn()
    else ê¸°ì¡´ ì„¸ì…˜ ì—†ìŒ
        MemexLogin->>Background: memexLogin()
        Background->>Content: GTM í‚¤ í™•ì¸
        Content->>Memex: sessionStorage í™•ì¸
        Memex-->>Content: GTM í‚¤ ì—†ìŒ
        Content-->>Background: { isLoggedIn: false }
        Background-->>MemexLogin: { isLoggedIn: false }
    end
    
    StartingLoading->>App: onComplete() (3ì´ˆ í›„)
    App->>ComingSoon: ë Œë”ë§
    
    Note over User,Backend: 2. ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œì‘
    User->>ComingSoon: "[ CONNECT >>> ]" ë²„íŠ¼ í´ë¦­
    ComingSoon->>TermsModal: ëª¨ë‹¬ í‘œì‹œ
    
    User->>TermsModal: "I Agree" ë²„íŠ¼ í´ë¦­
    TermsModal->>ComingSoon: onAgree() í˜¸ì¶œ
    
    ComingSoon->>Wallet: connect() í˜¸ì¶œ
    Wallet->>Background: walletConnect()
    Background->>Content: ì§€ê°‘ ì—°ê²° ìš”ì²­
    Content->>MetaMask: ì—°ê²° ìš”ì²­
    MetaMask->>User: ìŠ¹ì¸ íŒì—… í‘œì‹œ
    User->>MetaMask: ìŠ¹ì¸
    MetaMask-->>Content: { address }
    Content-->>Background: { address }
    Background-->>Wallet: { address }
    Wallet->>Wallet: setWalletConnectedAtom()
    
    ComingSoon->>ComingSoon: handleMemexLogin() ì‹œì‘
    
    Note over ComingSoon,Backend: 3. MEMEX ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤
    ComingSoon->>ComingSoon: getMemexUserInfo() í˜¸ì¶œ
    ComingSoon->>ComingSoon: sessionStorage['gtm_user_identifier'] í™•ì¸
    
    alt GTM í‚¤ ìˆìŒ
        ComingSoon->>Background: getUserByUsername()
        Background->>Backend: GET /api/users/by-username
        alt ë°±ì—”ë“œì— user ìˆìŒ
            Backend-->>Background: { user: User }
            Background-->>ComingSoon: { user: User }
            ComingSoon->>ComingSoon: setUser(), onMemexLoginComplete()
        else ë°±ì—”ë“œì— user ì—†ìŒ (ì‹ ê·œ)
            Backend-->>Background: { user: null }
            Background-->>ComingSoon: { user: null }
            ComingSoon->>Background: fetchMemexProfileInfo()
            Background->>Content: í”„ë¡œí•„ ì •ë³´ ìš”ì²­
            Content->>Memex: í”„ë¡œí•„ í˜ì´ì§€ ë°©ë¬¸
            Memex-->>Content: í”„ë¡œí•„ ì •ë³´ (ì´ë¯¸ì§€, í† í° ë“±)
            Content-->>Background: í”„ë¡œí•„ ì •ë³´
            Background-->>ComingSoon: í”„ë¡œí•„ ì •ë³´
            ComingSoon->>Background: join() ìš”ì²­
            Background->>Backend: POST /api/users/join
            Backend->>Backend: ì‚¬ìš©ì ìƒì„±/ì—…ë°ì´íŠ¸, ì¶œì„ ì²´í¬
            Backend-->>Background: { user: User }
            Background-->>ComingSoon: { user: User }
            ComingSoon->>ComingSoon: setUser(), onMemexLoginComplete()
        end
    else GTM í‚¤ ì—†ìŒ
        ComingSoon->>Background: memexLogin(true) - Google ë¡œê·¸ì¸ ì‹œì‘
        Background->>Content: Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
        Content->>Memex: Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜
        Memex->>User: Google ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        User->>Memex: Google ë¡œê·¸ì¸ ì™„ë£Œ
        Memex->>Memex: sessionStorage['gtm_user_identifier'] ì €ì¥
        
        ComingSoon->>ComingSoon: í´ë§ ì‹œì‘ (5ì´ˆ í›„, 2ì´ˆë§ˆë‹¤)
        loop í´ë§ (ìµœëŒ€ 60ì´ˆ)
            ComingSoon->>Background: memexLogin() - GTM í‚¤ í™•ì¸
            Background->>Content: GTM í‚¤ í™•ì¸
            Content->>Memex: sessionStorage í™•ì¸
            alt GTM í‚¤ ì•„ì§ ì—†ìŒ
                Memex-->>Content: GTM í‚¤ ì—†ìŒ
                Content-->>Background: { isLoggedIn: false }
                Background-->>ComingSoon: { isLoggedIn: false }
                ComingSoon->>ComingSoon: 2ì´ˆ í›„ ì¬ì‹œë„
            else GTM í‚¤ í™•ì¸ë¨
                Memex-->>Content: { username, userTag }
                Content-->>Background: { isLoggedIn: true, username, userTag }
                Background-->>ComingSoon: { isLoggedIn: true, username, userTag }
                ComingSoon->>Background: getUserByUsername()
                Background->>Backend: GET /api/users/by-username
                alt ë°±ì—”ë“œì— user ìˆìŒ
                    Backend-->>Background: { user: User }
                    Background-->>ComingSoon: { user: User }
                    ComingSoon->>ComingSoon: setUser(), onMemexLoginComplete()
                else ë°±ì—”ë“œì— user ì—†ìŒ (ì‹ ê·œ)
                    Backend-->>Background: { user: null }
                    Background-->>ComingSoon: { user: null }
                    ComingSoon->>Background: fetchMemexProfileInfo()
                    Background->>Content: í”„ë¡œí•„ ì •ë³´ ìš”ì²­
                    Content->>Memex: í”„ë¡œí•„ í˜ì´ì§€ ë°©ë¬¸
                    Memex-->>Content: í”„ë¡œí•„ ì •ë³´
                    Content-->>Background: í”„ë¡œí•„ ì •ë³´
                    Background-->>ComingSoon: í”„ë¡œí•„ ì •ë³´
                    ComingSoon->>Background: join() ìš”ì²­
                    Background->>Backend: POST /api/users/join
                    Backend-->>Background: { user: User }
                    Background-->>ComingSoon: { user: User }
                    ComingSoon->>ComingSoon: setUser(), onMemexLoginComplete()
                end
            end
        end
    end
    
    Note over ComingSoon,App: 4. ë¡œê·¸ì¸ ì™„ë£Œ
    ComingSoon->>App: onMemexLoginComplete(username, userTag)
    App->>MemexLogin: setMemexLoggedIn(true, username, userTag)
    MemexLogin->>MemexLogin: sessionAtom ì—…ë°ì´íŠ¸
    App->>App: Dashboard ë Œë”ë§
```

---

## 7. ë°ì´í„° ì €ì¥ ìœ„ì¹˜ ìš”ì•½

### 7.1 SessionStorage

| í‚¤ | ì„¤ëª… | ë°ì´í„° íƒ€ì… |
|---|---|---|
| `squid_session_state` | ì „ì²´ ì„¸ì…˜ ìƒíƒœ | `SessionState` |
| `squid_login_check_completed` | ë¡œê·¸ì¸ ì²´í¬ ì™„ë£Œ ì—¬ë¶€ | `boolean` |
| `gtm_user_identifier` | MEMEX ë¡œê·¸ì¸ ì •ë³´ (ìºì‹œ) | `MemexUserInfo` |

### 7.2 SessionState êµ¬ì¡°

```typescript
interface SessionState {
    // ì§€ê°‘ ì—°ê²° ìƒíƒœ
    isWalletConnected: boolean;
    walletAddress: string | null;

    // MEMEX ë¡œê·¸ì¸ ìƒíƒœ
    isMemexLoggedIn: boolean;
    memexUsername: string | null;
    memexUserTag: string | null;
    memexProfileImage: string | null;

    // MEMEX í”„ë¡œí•„ ì •ë³´ (í† í° ê´€ë ¨)
    memexWalletAddress: string | null;
    myTokenAddr: string | null;
    myTokenSymbol: string | null;
    myTokenImageUrl: string | null;

    // ë¡œë”© ìƒíƒœ
    isLoading: boolean;
    isLoggingIn: boolean;

    // ì—ëŸ¬
    error: string | null;

    // ë°±ì—”ë“œì—ì„œ ë°›ì€ ìœ ì € ì •ë³´
    user: User | null;
}
```

### 7.3 ë°±ì—”ë“œ ë°ì´í„°ë² ì´ìŠ¤

- **User í…Œì´ë¸”**: ì‚¬ìš©ì ì •ë³´ (username, userTag, walletAddress ë“±)
- **CheckIn í…Œì´ë¸”**: ì¶œì„ ì²´í¬ ê¸°ë¡

---

## 8. ì£¼ìš” API í˜¸ì¶œ

### 8.1 ë°±ì—”ë“œ API

| ì—”ë“œí¬ì¸íŠ¸ | ë©”ì„œë“œ | ì„¤ëª… |
|---|---|---|
| `/api/users/by-username` | GET | usernameê³¼ userTagë¡œ ì‚¬ìš©ì ì¡°íšŒ (ì¶œì„ ì²´í¬ í¬í•¨) |
| `/api/users/join` | POST | ì‹ ê·œ ì‚¬ìš©ì íšŒì›ê°€ì… ë˜ëŠ” ê¸°ì¡´ ì‚¬ìš©ì ì—…ë°ì´íŠ¸ |

### 8.2 Background Script ë©”ì‹œì§€

| ë©”ì‹œì§€ íƒ€ì… | ì„¤ëª… |
|---|---|
| `WALLET_GET_ACCOUNT` | í˜„ì¬ ì—°ê²°ëœ ì§€ê°‘ ê³„ì • ì¡°íšŒ |
| `WALLET_CONNECT` | ì§€ê°‘ ì—°ê²° ìš”ì²­ |
| `MEMEX_LOGIN` | MEMEX ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë˜ëŠ” Google ë¡œê·¸ì¸ ì‹œì‘ |
| `GET_USER_BY_USERNAME` | ë°±ì—”ë“œì—ì„œ ì‚¬ìš©ì ì¡°íšŒ |
| `FETCH_MEMEX_PROFILE_INFO` | MEMEX í”„ë¡œí•„ í˜ì´ì§€ì—ì„œ ì •ë³´ ì¶”ì¶œ |
| `JOIN` | ë°±ì—”ë“œì— ì‚¬ìš©ì ë“±ë¡/ì—…ë°ì´íŠ¸ |

---

## 9. ì—ëŸ¬ ì²˜ë¦¬

### 9.1 Content Script ì—°ê²° ì˜¤ë¥˜

**ìƒí™©**: MEMEX íƒ­ì´ ì—†ê±°ë‚˜ content scriptê°€ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš°

**ì²˜ë¦¬**:
- ìŠ¤ë‚µë°” í‘œì‹œ: "MEMEXì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”"
- "ì´ë™" ë²„íŠ¼ í´ë¦­ ì‹œ MEMEX íƒ­ ìƒˆë¡œê³ ì¹¨

### 9.2 ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨

**ìƒí™©**: MetaMask ì—°ê²° ê±°ë¶€ ë˜ëŠ” ì—ëŸ¬

**ì²˜ë¦¬**:
- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
- ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨

### 9.3 ë¡œê·¸ì¸ íƒ€ì„ì•„ì›ƒ

**ìƒí™©**: 60ì´ˆ ë‚´ì— Google ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ê²½ìš°

**ì²˜ë¦¬**:
- í´ë§ ì¤‘ë‹¨
- `isLoggingIn` ìƒíƒœë¥¼ `false`ë¡œ ë³€ê²½

### 9.4 í”„ë¡œí•„ ì •ë³´ ë¶€ì¡±

**ìƒí™©**: MEMEX í”„ë¡œí•„ì—ì„œ í•„ìˆ˜ ì •ë³´(ì´ë¯¸ì§€, í† í° ì£¼ì†Œ ë“±)ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ëŠ” ê²½ìš°

**ì²˜ë¦¬**:
- ìë™ íšŒì›ê°€ì… ì‹¤íŒ¨
- ì‚¬ìš©ìëŠ” ìˆ˜ë™ìœ¼ë¡œ ì •ë³´ ì…ë ¥ í•„ìš” (í˜„ì¬ëŠ” ì—ëŸ¬ ë¡œê·¸ë§Œ)

---

## 10. ì£¼ì˜ì‚¬í•­

1. **ì¤‘ë³µ ìš”ì²­ ë°©ì§€**: `joinRequestInProgress` í”Œë˜ê·¸ë¡œ Join ìš”ì²­ ì¤‘ë³µ ë°©ì§€
2. **í´ë§ ìµœì í™”**: ë¡œê·¸ì¸ ì™„ë£Œ í™•ì¸ í›„ ì¦‰ì‹œ í´ë§ ì¤‘ë‹¨
3. **ì„¸ì…˜ ë™ê¸°í™”**: `atomWithStorage`ë¥¼ ì‚¬ìš©í•˜ì—¬ sessionStorageì™€ ìë™ ë™ê¸°í™”
4. **ì¶œì„ ì²´í¬**: `getUserByUsername` API í˜¸ì¶œ ì‹œ ìë™ìœ¼ë¡œ ì¶œì„ ì²´í¬ ìˆ˜í–‰
5. **Content Script ì˜ì¡´ì„±**: MEMEX ì›¹ì‚¬ì´íŠ¸ê°€ ì—´ë ¤ìˆì–´ì•¼ ë¡œê·¸ì¸ ê°€ëŠ¥

---

## 11. ê°œì„  ê°€ëŠ¥í•œ ë¶€ë¶„

1. **ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”**: í”„ë¡œí•„ ì •ë³´ ë¶€ì¡± ì‹œ ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ì•ˆë‚´
2. **ë¡œë”© ìƒíƒœ ê°œì„ **: ê° ë‹¨ê³„ë³„ ë¡œë”© ìƒíƒœë¥¼ ë” ì„¸ë¶„í™”í•˜ì—¬ í‘œì‹œ
3. **ì¬ì‹œë„ ë¡œì§**: ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ìë™ ì¬ì‹œë„
4. **ì˜¤í”„ë¼ì¸ ëª¨ë“œ**: ë„¤íŠ¸ì›Œí¬ ì˜¤í”„ë¼ì¸ ìƒíƒœ ì²˜ë¦¬

---

**ì‘ì„±ì¼**: 2024ë…„
**ë²„ì „**: 1.0.0

